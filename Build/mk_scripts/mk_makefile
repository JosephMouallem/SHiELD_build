#!/bin/sh

#
## set default values
HYDRO="nh"
BIT="32bit"
COMPILER="intel"

#
### parse arguments
for arg in "$@"
do
    case $arg in
        nh|hydro)
        HYDRO="${arg#*=}"
        shift # Remove HYDRO from processing
        ;;
        32bit|64bit)
        BIT="${arg#*=}"
        shift # Remove *bit from processing
        ;;
        intel|gnu)
        COMPILER="${arg#*=}"
        shift # Remove compiler from processing
        ;;
    esac
done

#
# GFS CPPDEFS
GFS_cppDefs="-DNEW_TAUCTMAX -DNEMS_GSM -DINTERNAL_FILE_NML"

#
# FV3 CPPDEFS
FV3_cppDefs="-Duse_libMPI -Duse_netCDF -DHAVE_SCHED_GETAFFINITY -DSPMD -DUSE_LOG_DIAG_FIELD_INFO -Duse_LARGEFILE \
             -DUSE_GFSL63 -DGFS_PHYS -DNO_CMIP_DIAG -DINTERNAL_FILE_NML"

#
# non-hydrostatic CPPDEFS
if [ ${HYDRO} = "nh" ] ; then
  FV3_cppDefs="${FV3_cppDefs} -DMOIST_CAPPA -DUSE_COND"
fi

pushd exec/${COMPILER}/

############################
#---CREATE MAKEFILES
############################
mkmf -m Makefile_gfs -a ${SHiELD_SRC} -t "${BUILD_ROOT}/${TEMPLATE}" -o "-cpp" -c "${GFS_cppDefs}" \
         -p libgfs.a ${BUILD_ROOT}/Build/exec/${COMPILER}/pathnames_gfs

mkmf -m Makefile_fv3 -a ${SHiELD_SRC} -t "${BUILD_ROOT}/${TEMPLATE}" -c "${FV3_cppDefs}" \
         -p test.x -o "-I${SHiELD_SRC}/FMS/include -I${BUILD_ROOT}/Build/libFMS/${COMPILER}/${BIT}" \
          ${BUILD_ROOT}/Build/exec/${COMPILER}/pathnames_fv3

############################
#---ADD LIBS TO FINAL LINK
############################
sed 's/LDFLAGS/NCEPLIBS) $(LDFLAGS/g' < Makefile_fv3 > OUT
mv OUT Makefile_fv3

############################
#---COMPILE -O0 (for speed)
#---GFS_diagnostics.F90
############################
sed -i 's"$(FC) $(CPPDEFS) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -c\t$(SRCROOT)fv3_gfsphysics/GFS_layer/GFS_diagnostics.F90" $(FC) $(CPPDEFS) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -O0 -c\t$(SRCROOT)fv3_gfsphysics/GFS_layer/GFS_diagnostics.F90" ' Makefile_gfs

############################
#---COMPILE -xCORE-AVX-I
#---radiation_aerosols.f
############################
if [ ${COMPILER} = 'intel' ] ; then
  sed -i 's"$(FC) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -c\t$(SRCROOT)fv3_gfsphysics/gsmphys/radiation_aerosols.f"$(FC) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -xCORE-AVX-I -c\t$(SRCROOT)fv3_gfsphysics/gsmphys/radiation_aerosols.f"' Makefile_gfs
fi

############################
#---ADD FAST TRANSCENDENTALS
#---model/nh_utils.F90
#---model/fv_mapz.F90
############################
sed -i 's"$(FC) $(CPPDEFS) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -c\t$(SRCROOT)atmos_cubed_sphere/model/nh_utils.F90"$(FC) $(CPPDEFS) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) $(FAST) -c\t$(SRCROOT)atmos_cubed_sphere/model/nh_utils.F90"' Makefile_fv3

sed -i 's"$(FC) $(CPPDEFS) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -c\t$(SRCROOT)atmos_cubed_sphere/model/fv_mapz.F90"$(FC) $(CPPDEFS) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) $(FAST) -c\t$(SRCROOT)atmos_cubed_sphere/model/fv_mapz.F90"' Makefile_fv3

############################

popd

exit 0
